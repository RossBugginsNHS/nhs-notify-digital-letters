name: 'Setup depenasdf with cache'
description: 'Restores asdf cache, installs dependencies, and saves cache'
runs:
  using: "composite"
  steps:
    - name: "Restore asdf cache"
      id: cache-asdf
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.asdf
        key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}
        restore-keys: |
          ${{ runner.os }}-asdf-

    - name: "Check cache status"
      shell: bash
      run: |
        if [ "${{ steps.cache-asdf.outputs.cache-hit }}" == "true" ]; then
          echo "âœ… Cache hit! asdf and tools restored from cache. ğŸš€ğŸš€ğŸš€"
        else
          echo "âŒ Cache miss. asdf and tools will be installed from scratch. ğŸ”¨ğŸ”¨ğŸ”¨"
        fi

    - name: "Install dependencies"
      shell: bash -l {0}
      run: |
        make dependencies

    - name: "Save asdf cache"
      id: save-asdf-cache
      if: steps.cache-asdf.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          ~/.asdf
        key: ${{ steps.cache-asdf.outputs.cache-primary-key }}

    - name: "Check cache save status"
      shell: bash
      run: |
        if [ "${{ steps.cache-asdf.outputs.cache-hit }}" == "true" ]; then
          echo "â„¹ï¸  Cache was restored from previous run - no save needed"
        elif [ "${{ steps.save-asdf-cache.outcome }}" == "success" ]; then
          echo "âœ… Cache saved successfully for future runs! ğŸ’¾"
        else
          echo "âš ï¸  Cache save was skipped or failed"
        fi
